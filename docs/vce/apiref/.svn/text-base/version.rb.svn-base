#
# version.rb
#   insert current version into all html 
#   except vce-api.html, vce-files.html, vce-tool.html
#
require "kconv"

def main
    if( ARGV.size != 4 ) then
        STDERR.print "Usage: version.rb [ver] [copyright] [search_dir] [out_dir]\n"
        exit 0
    end

    ver = ARGV[0]    
    copyright = ARGV[1]
    conv_dir = ARGV[2]
    outdir = ARGV[3]

    `find #{conv_dir} -name \'*.html\'`.split("\n").each{ |fn|
        ins_version( ver,copyright,fn,outdir)
    }
end

def ins_version(ver,copyright,fn,outdir)
    tmp = fn.split("/")
    dirsrc = tmp[0]
#    lang = tmp[1]
#    name = tmp[2]
#    name = tmp[2]
#    outfn = "#{outdir}/#{lang}/#{name}"
    outfn = fn.gsub(dirsrc,outdir)

    # except vce-api.html , vce-tool.html and vce-files.html
    if( fn =~ /vce-/ ) then
        system( "cp #{fn} #{outfn}" )
        return
    end

    buf = File.open(fn,"r").read
    outbuf = ""

    buf.split("\n").each{ |line|
        line.sub!( "#VER#", ver )         
        line.sub!( "#COPYRIGHT#", copyright )
        outbuf += "#{line}\n"
    }

    outbuf = Kconv.toutf8(outbuf)    
    outf = File.open(outfn,"w+")
    outf.puts outbuf    
    outf.close    
    
end

main()

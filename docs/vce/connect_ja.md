VCEサーバーにおける最大接続数について
====


このドキュメントでは、VCEを用いたクライアントが、(VCEを用いた)サーバに接続するときの
成功判定、失敗判定の方法について、特に接続数が最大値に達した時に着目して解説します。


##推奨される接続方法


VCEを使ったアプリケーションでは、ノンブロッキング接続を用いて、
vce_conn_writable 関数のみを使って接続成功テストをすることが推奨されます。


~~~
tcpcontext_t t = vce_tcpontext_create( 0, ... );
conn_t new_con = vce_tcpcontext_connect( t, "localhost" , 80 );
while (1 ){
  vce_heartbeat();
  if( vce_conn_writable( new_con ) >= 4 ){
    vce_conn_write( new_con, "test" , 4 ); 
  } else {
    // 一定時間たったら、失敗を通知
  }
}      
~~~


この方式の場合は、何らかのタイマーを使って、
一定時間以内に vce_conn_writable が正の値を返さない場合はクライアント端末上にエラーを表示するといった処理を追加して、ユーザーに接続できない旨を知らせることになります。

ところが、テスト用プログラムや、サーバの監視用プログラムなど、
そのような手続きを踏むのを省略して簡単に作りたい場合も多くあります。
VCEの「ブロッキング接続」はそのような目的のために利用可能です。

特にシンラ・システムでN:Nゲームを作る場合は、
VCEはデータセンター内での通信にのみ使われるので、TCPの接続に時間がかかったり失敗することはまずありません。

ブロッキング接続の場合は、以下のような感じでループをさせることなく、
接続成功確認ができます。


~~~
tcpcontext_t t = vce_tcpontext_create( 0, ... );
conn_t new_con = vce_tcpcontext_connect( t, "localhost" , 80 );
if( vce_conn_is_valid( new_con ) == 0 ){
  // 失敗! ここで判定できるので便利 
}
while (1 ){
  vce_heartbeat();
  if( vce_conn_writable(new_con) > 0 ){
    // 書きこみ処理 
  }
}
~~~

ところが、この方法を用いる場合でも、サーバが絶対最大接続数に達している場合だけは、
期待通りの動作をしません。

具体的には上の例で vce_conn_is_valid 関数が真を返しているのに、
ループを開始すると vce_conn_writable がエラーを返します。

実際にはサーバは最大接続に達しているので、
最終的には vce_conn_writable がエラーを返すのは当然ですが、
一番最初の vce_conn_is_valid が真を返すのかが問題となります。

この原因は、VCEサーバにおいて最大接続数に達したときの動作が原因です。

VCEサーバにおいては、クライアントからの接続の数があらかじめ設定された最大値に達した場合は、
一旦接続を受けいれ(accept)てから、改めて切断(close)しているからです。

VCEをはじめUNIXの各ツール(apacheなども) がこのような仕様になっているのは、
ソケットライブラリの機能上の制限があるからです。

その制限とは、まずUNIXのソケットライブラリが、最大接続数を制限する機能を持っていないことです。　TCP/IP の機能により、あるサーバが最大接続数に達している場合に connection refused を返す手段がないため、OSではなくアプリケーションのレイヤでそれに対応しなければなりません。

アプリケーションでは、最大接続数に到達した瞬間にbindとlistenをしていたソケットを解放して、connection refusedが返されるようにできます。
しかし、最大接続数付近で、同じポートをbind/listen したり、解放したりを繰りかえすのは、あまりよい実装方法ではありません。　OSのパフォーマンス上の理由や、DoS攻撃のようなセキュリティホールの原因にもなりえるからです。

このようなことから、現在UNIX上で動作するサーバアプリケーションは、一旦acceptしてから closeするという動作がデフォルトとなっています。


##最大接続数の扱い


VCE では、最大接続数を越えた接続に関しては、上で説明したような動作がデフォルトとなっています。
しかしこの動作のままでは、サーバが混雑しているときにアクセスしたユーザにとって、サーバがトラブルを起こしているのか、混雑が発生しているのか、知ることができません。

そこで、VCEでは、絶対的最大接続数のほかに、「仮の」最大接続数を設定して、仮の最大接続数を越えた接続を受けいれたときに別の接続監視関数を呼びだす機能を備えています。

それが vce_tcpcontext_set_conn_hiwater_acceptwatcher 関数と、
vce_tcpcontext_set_circ_hiwater_acceptwatcher 関数です。

アプリケーションでは、このコールバック関数を利用して、ユーザーに警告を表示したりといった機能を実装することが可能です。

詳細に関しては、 vce_tcpcontext_set_conn_hiwater_acceptwatcher 関数を参照してください。

